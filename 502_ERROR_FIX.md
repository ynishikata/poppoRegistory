# 502エラーの対処法

## 症状

```
Preflight response is not successful. Status code: 502
Fetch API cannot load https://poppo-backend.onrender.com/api/plushies due to access control checks.
```

## 原因

502 Bad Gatewayエラーは、Renderのプロキシとバックエンドサーバー間で問題が発生していることを示します。

### 主な原因

1. **バックエンドがスリープしている**（最も可能性が高い）
   - 無料プランでは15分間非アクティブでスリープ
   - 起動に30秒〜1分かかる

2. **バックエンドが起動していない**
   - ビルドエラー
   - 起動エラー
   - 環境変数の問題

3. **バックエンドがクラッシュしている**
   - アプリケーションエラー
   - データベースエラー

## 対処法

### 1. バックエンドを手動で起動

ブラウザで以下のURLに直接アクセス:
```
https://poppo-backend.onrender.com/api/me
```

- **401 Unauthorized**: バックエンドは起動している（正常）
- **502 Bad Gateway**: バックエンドが起動していない、またはスリープ中
- **接続エラー**: バックエンドが存在しない、またはURLが間違っている

### 2. Render Dashboardで確認

1. **バックエンドサービスのステータスを確認**
   - "Live": 起動中
   - "Sleeping": スリープ中 ← これが原因の可能性が高い
   - "Building": ビルド中
   - "Deploying": デプロイ中
   - "Failed": エラー

2. **"Logs" タブを確認**
   - 最新のログを確認
   - エラーメッセージがないか確認
   - `Server listening on :8080` が表示されているか確認

### 3. バックエンドを再デプロイ

1. Render Dashboardでバックエンドサービスを選択
2. "Manual Deploy" → "Deploy latest commit" をクリック
3. ビルドとデプロイが完了するまで待つ（3〜7分）
4. デプロイ完了後、再度試す

### 4. 環境変数の確認

Render Dashboardで：
1. バックエンドサービス → "Environment" タブ
2. 以下が設定されているか確認：
   - `SUPABASE_JWT_SECRET`: **必須**
   - `PORT`: デフォルト8080（設定不要でもOK）
   - `CORS_ORIGINS`: `https://poppo-frontend.onrender.com`

## よくある問題と解決方法

### 問題1: バックエンドがスリープしている

**症状:**
- 502 Bad Gateway
- 初回アクセス時にタイムアウト

**解決方法:**
1. バックエンドのURLに直接アクセスして起動
2. 30秒〜1分待つ
3. 再度試す

### 問題2: ビルドエラー

**症状:**
- デプロイが失敗する
- "Build failed" と表示

**解決方法:**
1. "Logs" タブでビルドエラーを確認
2. エラー内容に応じて修正
3. 再デプロイ

### 問題3: 起動エラー

**症状:**
- デプロイは成功するが、起動しない
- ログにエラーメッセージが表示される

**解決方法:**
1. "Logs" タブでエラーメッセージを確認
2. 環境変数が正しく設定されているか確認
3. エラー内容に応じて修正

## 確認チェックリスト

- [ ] バックエンドのURLに直接アクセスした
- [ ] Render Dashboardでバックエンドのステータスを確認した
- [ ] "Logs" タブでログを確認した
- [ ] 環境変数が設定されているか確認した
- [ ] バックエンドを再デプロイした

## 次のステップ

1. **まず、バックエンドのURLに直接アクセス**
   ```
   https://poppo-backend.onrender.com/api/me
   ```

2. **Render Dashboardのログを確認**
   - 最新のログを確認
   - エラーメッセージがないか確認

3. **問題が解決しない場合**
   - バックエンドを再デプロイ
   - 環境変数を再確認

## 502エラーが続く場合

502エラーが続く場合は、以下を試してください：

1. **バックエンドサービスを削除して再作成**
   - 設定に問題がある可能性

2. **有料プランにアップグレード**
   - スリープなしで動作
   - より安定した動作

3. **別のホスティングサービスを検討**
   - Fly.io（スリープなし、無料プラン）
   - Railway（$5の無料クレジット）

